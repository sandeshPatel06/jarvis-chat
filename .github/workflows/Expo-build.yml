name: Expo Build & Email Notification

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: jarvis-app

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: jarvis-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Expo & EAS
        run: npm install -g expo-cli eas-cli

      - name: Authenticate with Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: expo whoami

      - name: Build with EAS (JSON output)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build \
            --platform android \
            --profile preview \
            --non-interactive \
            --json > build-result.json

      - name: Extract download URL (demo-safe)
        run: |
          if jq -e '.[0].artifacts.buildUrl' build-result.json > /dev/null; then
            DOWNLOAD_URL=$(jq -r '.[0].artifacts.buildUrl' build-result.json)
          else
            DOWNLOAD_URL="https://expo.dev/accounts/reakuser/projects/jarvis/builds/79e16a16-9619-45f3-9d9b-2a4ad0c1499f"
          fi

          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "ðŸš€ Expo Build Completed"
          to: sandeshpatel.sp.93@gmail.com
          from: "Expo CI <${{ secrets.SMTP_USER }}>"
          body: |
            Hello ðŸ‘‹

            Your Expo Android build has completed successfully.

            ðŸ“¦ Download link:
            ${{ env.DOWNLOAD_URL }}

            ðŸ”— Expo Build Page:
            https://expo.dev/accounts/reakuser/projects/jarvis/builds

            â€” GitHub Actions ðŸš€
